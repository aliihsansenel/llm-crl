Technical details of frontend of the llm-crl web app project:
This is a react typescript frontend project.
Supabase db used primarily for user-db interactions.
For client runtime, there are 3 roles, anon (user who have not logged in), standart_user (as a value jwt token's user_role key), admin (as a value jwt token's user_role key).
As a deducted role I can say "authenticated" role. "standart_user" and "admin" are authenticated users.
Table access control managed inside Supabase, however client runtime (this frontend project) should be aware of which db operations is permitted based on role of user and based on the detailed explanation in this file for best user experience.

Project's bussiness logic:
  Users can create vocabulary, add meanings to vocabulary item, create vocabulary lists, add/remove item from own lists, can subscribe to other users' lists.
  Users can create reading and listening material (rl_item) for vocabulary and meaning, can create lists for rl_items, add/remove item from own lists, can subscribe to other users' lists.
  Implementations for Creating reading/listening material and corresponding lists are subject to another phase so Coder LLM should not implement pages or components for now.


Tables' column details explained in another file, in that file rls policies or column based rectrictions are not written. However some of the rls policies, and column based restrictions explained here,
Tables and interactions of users with different roles (this sections have code creation instructions for Coder LLM):

auth.users (table): This table built-in supabase table for user management. id column of this table is referenced by multiple tables of my project, every table except this under public schema.

admins (table): only authenticated users can see, no one can change or delete table items.

levels (table): no one can change or delete table items, users will use this table for level lookup. 

settings (table): settings of authenticated users, user can change own settings. auto_confirm (1, 2) columns holds boolean and will be used for auto confirms. In need they can be sequentially populated.

profiles (table): profiles of authenticated users, user can change own profiles

tokens (table): authenticated users can see own admin can see anyone's tokens. Bu no one can update tokens table (in frontend).

p_vocab_lists (table): authenticated users can create only one private (p) vocab list for themselves. This lists are nameless. A standart_user can only use own private list.

p_vocab_list_items (table): authenticated users will use this table to add/remove vocab items to their private lists.

vocab_lists (table): Public vocab lists authenticated users can create.

vocab_list_items (table): Items of public vocabulary lists. Only owner or admin can add/remove items of these.

vocab_lists_sub (table): A authenticated user can subscribe to others' lists but can not sub to own list.

vocabs (table): User can create or delete vocabulary but can not update.

meanings (table): authenticated users can attach meanings to a vocabulary item (vocabulary item can be owned by others). There will no dedicated page users can list meanings. Meanings can be visible under vocabulary they attached to.


These tables' code implementation is for another phase of the project, so do not create any page or logic implementation for these table:
!!! New edit: Now we come to the phase that we need to implement some of these tables logic (not all). So look at final part of this file: the section "New implementation request(s) for Coder LLM:"
What are the tables need to be connected with client according to instructions? Developer answers:
first and most importantly: rl_items and rl_item_vocabs_and_meanings. (code related to other than these two tables of this phase will be implemented in another iteration so ignore other rl related tables).
Notice: RLS policies and column based restrictions in rl_items table are very restrictive for both admin and standart_user, since business logic is complex and state based, most of the update operations on this table will be handled by a custom edge function in server. Do not attempt to suggest or write code for that edge function, Developer will specify input and outputs of request to that function.
restrictions was set for insert in supabase: REVOKE INSERT (id, title, instructions, r_item, l_item_id, delete_requested, created_at, modified_at) ON public.rl_items FROM authenticated;
restrictions was set for update in supabase REVOKE UPDATE (id, title, instructions, r_item, l_item_id, level_id, created_at, modified_at) ON public.rl_items FROM authenticated;
on the other hand only SELECT available for client (js supabase client) for table rl_item_vocabs_and_meanings. Edge function will handle db operations.

Context: rl abbrevation stands for reading and listening, user will select meanings of 3-4 different vocabulary. User can select only on meaning of a vocabulary, but since user can select same vocab then choose another meaning indirectly multiple meaning selection is allowed but in the final a spesific rl_item only can be related to maximum 4 row of table rl_item_vocabs_and_meanings, there is a limit.  

rl_items (table): user can select all items in rl_item, insert with only own id (owner_id), UPDATE is only to delete_requested and owner_id column to ask for deletion (only admin can delete) or user can drop ownership himself to null. Actually DELETE is allowed under some conditions but told very bottom of this file so consider new information.

p_rl_lists (table): similar logic as p_vocab_list: personal list for rl_item, but consider the schema.

p_rl_list_items (table): similar logic as p_vocab_list_items: items of personal list for rl_item, but consider the schema.

rl_item_vocabs_and_meanings (table): vocab and meanings of a spesific rl_item

We are in the iteration, these table's usages are also needed to be in ui:

rl_list_items (table): public list's items for rl_item, user can delete or insert to owned list items.

rl_lists (table): public lists for rl_item, user can delete, insert and update, owned lists.

rl_lists_sub (table): user can subscribe or unsubscribe to rl_lists.

Finally, instructions for building ui for Coder LLM:

- use react with typescript
- do not use npm package manager directly, use pnpm instead.
- Developer created and initiliazed this project using vite.
- primarily shadcn and its indirect dependencies like tailwind css and radix elements should be preferred for building ui.
- Developer have installed some components already. If necessary, install shadcn components by executing commands like "pnpm dlx shadcn@latest add button"
- react-router (7) "data" mode should be used for navigation and page routing, do not use "framework" or "declarative" mode.
- @supabase/supabase-js supabase client should be used for crud db queries.

The pages developer wanted to be built by Coder LLM (Coder LLM implemented some of the instructions here so ignore for instructions but learn from here):
- Drawer (shadcn) will be visible whatever the current page is. Drawer have My Profile, Discover, My Vocabulary, Reading/Listening Material(empty link) 
- Login page: /login user can login with email pass pair.
- Sign up page: /signup anon users can sign up with email pass pair.
- Signup and Login view should be accesible with tab (shadcn) switch in same page (on click url changes if possible)
- Profile page: for own /profile /profile?id={other's id}, users can view and update profile, after profile details place a settings and user can update it. (settings in others' profile page is hidden)
- My lists page: / is root path,
in /vocabs user will see own vocabulary words (do not list vocabs that owner_id is same with user, list p_vocab_list_items of owned p_vocab_list), and can remove by clicking a button.
in /lists user will see own vocab_lists and subscribed lists, here user can create or remove own existing lists or subscribtions.
- Profile page: /profile 
- /discover/ page have two tabs pointing /discover/vocabs and /discover/lists
- /discover/vocabs page of all vocabulary randomly selected (by any owner_id),
- /discover/lists page all lists recently randomly selected (by any owner_id),

user actions:
- Scenario: If a user wants to remove a vocabulary (in owned p_vocab_list_items) a popup asks if he/she also wants to remove attached owned meanings and presence in owned lists. User can choose "remove from this list only" or "remove all occurences". If user selected second, attempt to remove vocab item from owned vocab_list_items and owned meanings. Finally regardless of which option the user selected attempt to delete vocab itself (from vocabs table) supabase can reject if another uses this vocab so if you rejected because of this reason this should be ignored and not displayed to user as error.
- Scenario: if a user wants to delete an owned vobaulary list: If user did not activate toggle of the auto_confirm option in settings table (you choose which one), a popup must shown to user asks to confirm understanded "if another user have subscribed to the list can not be deleted, you will be drop ownership". User can cancel or proceed the operation but if he/she checks "do not show again" checkbox corresponding auto_confirm should be set to true. Then if proceed selected regardless of the state of the cehckbox attempt to delete vocab_list itself. If supabase rejects just drop the ownership of vocab_list supabase will allows it anyway.
- If user in discovery in /discover/vocabs section must provided buttons so user can save vocabulary to own private list (do not ask to which public list he can insert to because it will prevent user can squantially save vocabulary so just add to his private list )
- If user in discovery in /discover/lists section must provided buttons so user can subscribe to lists.
- If a user clicks a vocabulary a popup is displayed showing vocabulary with its meanings, in popup put a button to dedicated page of clicked vocabulary /vocabs?={id} url is valid for own and other's lists, notice /discover is not preceded by /vocab even it is list of someone else.
- Same goes same with /lists if clicked popup shows items and button to go dedicated page, in dedicated page's url id is provided then it is a dedicated page.
- If user's personal profile, settings, personal vocab list does not exist (maybe they could not be automatically created on signup) create then re-fetch.


Iteration context for Coder LLM:
- Some code written by Coder LLM so some of the previous (write code for this and this type) instructions could be not valid anymore so just implement after you see "New implementation request(s)", but consider every rule above since they are still valid.

Implementations made by Coder LLM previously (they could be implemented incomplete, check out new requests below):
- in /vocabs vocab items of private list is listed, I can remove but I need button to add, if user clicks add new let user type and on confirm add to private list and global vocab list.
- Drawer implemented previosly by Coder LLM, deactivated later for some problems, Activate it I want it to be visible by default and can be collapsed. And fix its size it was not right.
- root path should navigate to /vocabs path if logged in otherwise navigate to login page.
- I see when vocabulary added to private list client re-fetchs updated list that is unnecessary. If there are same behaviours in different pages also fix them.
- Make every page (except sign up and login) navigate to login page if not logged in.
- Drawer does not fill viewport vertically please fix it.
- Also add "Login & Sign up" link to drawer as first item visible to anon (who are not logged in yet even if he signed up).
- revert this behaviour: Make every page (except sign up and login) navigate to login page if not logged in.
Only /profile and /vocabs pages should navigate to /login if not logged in.
- navigation-menu component (shadcn) installed, place it top of pages.
- at very right of nav menu place import { UserCircle } from "@mynaui/icons-react"; on click it should navigate to profile page. If not logged in import { UserX } from "@mynaui/icons-react"; should be displayed and onclick navigate to login page.
- at right of the navbar and left beside of profile icon write free tokens and paid tokens (fetch data from tokens table but do not fetch again for every page navigation)
- at very left of navigation menu add menu icon from import { Menu } from "@mynaui/icons-react"; (required library installed). This icon will display drawer on click.
- Drawer comes its place bottom to top, it should be left to right.
- Drawer opens top of page and dims page, I want it to push page content to right. In desktop size it should be opened default.
- Only in mobile viewport size top level drawer and dimming are wanted.
- Drawer should be closeable, close button inside drawer does not work.
- ensure menu icon makes display drawer onclick (I can not check if this is working as I can not close to re-open).
- add "Log out" link to drawer but should act like button that opens popup confirm box asking to log out (this corfirmation should not be linked to any auto_confirm settings).
- inputs and textareas do not have border and it seems they are not shadcn components but fundamental html elements, turn them to shadcn components and ask for confirmation to developer before ending task.
- Turn Log out link in drawer into black button
- create alert (I installed pnpm dlx shadcn@latest add alert) beneath the login form to inform user login unsuccesfull, inf success ful navigate to /vocabs page.
- turn every alert-confirmation behavour done with basic default js alert into alert-dialog (I installed pnpm dlx shadcn@latest add alert alert-dialog).
- in /lists page under the title Owned Lists (notice these lists are vocab_lists not private) create a button "Create list" beneath the listed lists (even if there is not any list). on click insert to table vocab_list as request ongoing disable button and turn text into "Creating..." then after list created open list's dedicated page in new browser tab.
- in dedicated list page user's saved vocabulary should be listed (last added to first added (reverse order) limit recently added 20 vocabulary items). Beside vocabulary "add" button to add to the list. make lower added vocabularies' opacity. And since added vocabularies listed in lists add remove button beside them. If there is no Item in users private vocab list. Write an alert (shadcn) and place a button to navigate user to /vocabs page.
- in profile page I can not update username fix this problem.
- dedicated list page is created but needs modifications and fixes since it has faulty behaviour,
I'll describe what final behaviour should be:
1. list items vocabs and 2. items of private vocabs list
seperate this two lists one under the other, since first list is current list's items (the list which currently user add vocab items to) need no header and should be placed on top of second list. on the other hand second list should have header "Add items from your personal vocabulary list",
beside vocabulary items in second list should have only one button "Add", on page display make vocab items in second lists which are already in first list set opacity to 30% and hide add buttons. when clicked add to top list immediately, while required db request is being made (concurrently, do not wait supabase's response), and make item on bottom list 30% opacity and hide add button, if supabase rejects undo this actions. 
beside vocabulary items in first list place a remove button, but remove action must wait supabase response.
- do not fetch updated list after every action as it is not necessary,
- this problem solved: in profile page I can not update username fix this problem. I detected ensureUserResources triggered when loadProfileAndSettings runs, ensureUserResources should only run if profile row doesn't exist for current user.
- this problem solved: Other request of Developer is about consecutive same requests, fetch requests monitored on network tab of developer tools and I (as Developer) see same requests being made consecutively on every page of project, 2 or even 4 times on some pages, please fix it.
- When I create a list and, go to detailed page, I see all of my vocab items on private list added visually to list already please fix this behaviour.
- Then ask me to test after fix if if I confirm I might say another related problem to fix.
- In discover page vocabs listed as you know, There is details option which lists meanings (itself) but not sentences, thats what I wanted. Now I want same in /vocabs for private list items. There is remove button in private list items place details button before remove button.
- In vocabs details page I see meanings listed with example sentences that is good. But I need buttons and features for creating, deleting meanings and sentences. Keep in mind any authenticated user can create meanings but update and delete can be rejected by (supabase's foreign key restrictions) so if update or delete rejected show user an alert dialog says that user can drop ownership instead or cancel, if user select drop ownership attempt to drop ownership. Also meanings have owner_id if user is not owner or he is not admin do not show update or delete buttons, that user can only add meanings and attach/remove sentences to own meanings (after request being made supabase will decide like I told before).
- for meaning and sentence creation open a popover (installed already from shadcn), user will make changes in view inside popover.
- Create a /rl-items page like vocabs page, check out /vocabs page as it sets an example, place private list of rl_items, and create new button, on button click create a rl_item by INSERT, add to private list then navigate to /rl-items?id={id} page, as in vocabs page beside the details button also opens related /rl-items?id={id} page
- Create detailed page /rl-items?id={id},
this page has a header as title of rl_item (will be initially null so display "Unnamed Content"), user has not option to edit,
just bottom of title, place a section seperated vertically so they should be side by side (for [vocab and meanings pair] and [list area]), this two areas should be seperated into two vertically, in the area of pairs there should be initially listed 3 pairs, since user have to select vocab first in the list area (the one in the right), last added 30 items of private vocab list, once user selects vocab delist vocabs and list all (ownership is not filtered) meanings of this vocabulary (do not show example sentences here)
user can add and remove 4th row of vocab meaning pair, but can not exceed 4 or go under 3, selecting one item on left area (vocab or meaning) must make right area adapt itself.
vocab-meaning pair should be unique for one rl_item so in right area disabled meaning option already selected (meanings cannot be meaning of two vocabs).
- after vocab-meanings pair selection place a text area for user instructions with placeholder text. (context: this text will be injected inside prompt to inform llm (edge function's job again))
- after above components place a "Create Reading material" button, this button must be disabled until vocab-meaning pairs are satisfy the conditions.
- after "Create Reading material" button there should be a large area for created reading text for given vocabularies and meanings. this text cannot be editable by user.
- state of l_item_id vastly affects this page's functionality and updateability of rl_item:
if l_item_id is null initially and even after user have reading material created, as long as l_item_id is null user can re-generate new reading material or delete rl_item directly (without needing to raise flag of deleted_requested)
but if l_item_id is not null instead of change text of delete button to "delete request" and change behavior to update deleted_requested to true
if l_item_id is full of zeros that means listening material is being generated (listening material generation will be handled in aws lambda asynchronously and takes for a while)
- listening material is for another iteration so ignore l_item ui component but consider its null or not null state.
- I want to remark again: only SELECT is available for client (js supabase) for table rl_item_vocabs_and_meanings. So do not try to insert, update or delete items (edge function will handle all of these).
- edge function will return all the new state of rl_item so trust on the response and do not fetch updated rl_item after it (edge function's response).
- access and use edge function with name /temp-create-reading-text. (example url: https://adsyqluqnekrmgrjzbfl.supabase.co/functions/v1/temp-create-reading-text)
input parameters are: id of rl_item, list of [id of meanings] and instructions as text (notice there is no vocab id since meanings id conveys all necessary information).
output of this function: new "title" (title column), created reading text "r_item" and new "l_item_id", update page according to response.
- do not give an option to to drop ownership of rl_item either on detailed page or private list of rl_items. drop ownership functionality is not a subject of these pages for now.
- in rl-items page add "remove" button beside rl_items of p_rl_list_items. on click first remove from p_rl_list_items then attempt to delete item from rl_items if user is owner and l_item_id is null if you rejected by supabase update delete_requested to true.
- in rl_item's dedicated page delete button should remove item from user's p_rl_list_items, and if owner of rl_item is user open an alert_dialog asks if user wants to delete rl_item itself. If user says yes: cehck if l_item_id is null if yes delete item from rl_items if you rejected by supabase update delete_requested to true.
- /lists page now should include owned rl_lists and subscribed rl lists, to prevent confusion rename currently existing headers in ui in that page, but do not change any url
- create dedicated rl_list page, (dedicated page of a rl_list) page's url should be /rl-lists?id={id}
- do not change dedicated vocabulary list page urls
- add a dropwdown-menu (shadcn) to profile page under settings just before auto confirm settings, present to user as "Your reading material will be generated on the level you chose."
- add same dropwdown-menu (shadcn) to RlItemDetail.tsx page, and set default value match the level user set in settings (is nullable do not forget).
- on RlItemDetail.tsx page "Create Reading material" must be disabled if level is null
- add level_id to the edge functions request body (not corresponding level.itself, just send level_id)
- request to edge function should include authenticated user's jwt token, I modified code to desired version do not change into anon user again.
- changed edge function to /create-reading-text
- on page load fetch necessary rl_item_vocabs_and_meanings and set vocab meaning pairs (pairs that can be 3-4 ), and also instructions from rl_item I see them empty, fill level dropdown with level_id from rl_item, if it is null fill from user level_id settings.
- edge function in RlItemDetail.tsx page used returns this as response so please fill necessary components with this information after "create reding text" receives response from edge function:
return new Response(JSON.stringify({ok:true,rl_item:{id,title:parsed.title,text:parsed.text,level_id},tokens:{free:freeLeft,paid:paidLeft}})
- on page load now everything set correctly, but since response of edge function takes for a while I want you to increase timeout to 20 seconds, and I see red color of request in browser even if response is 200 and fields are not completed with edge functions response.
- I have created two functions, one of this publicly available https://5lklgc5015.execute-api.eu-central-1.amazonaws.com/default/create-listening-audio
consider the new db schema I created a l_items table and connect rl_items table with foreign key relationship, so add a "create listening material" button, button should be active if l_item_id is null, if l_item_id is full of zeros it means audio file being created. if so poll rl_item every 5 seconds.
- create a audio player component (can be simple, left out advanced improvements for another iteration if complex).
- once audio file is created it will be ready, and be accesible with url
- on page load do not automatically download audio file (aws outgoing traffic is subject to prices)
- do not forget only one l_item can be created for a rl_item. Users need to create another rl_item to create another audio.
- We implemented listening material generation feature using lambda functions, but created links for accessing audio files expires, so I need you to write another lambda function to re sign url again. So check out "create-listening-audio" function as an example. and create another directory and write code there. do not modify existing functions or do not new function try to invoke them, just write new function for dedicated on this purpose. do not try to deploy functions to aws I'll handle it.
- After completing lambda function change behaviour of RlItemDetail audio download. I want on click download behaviour kept. But since url expires, if you rejected by 403 invoke lambda function you just wrote (you will not have url of lambda function just wrote placholder code I will manually add correct lamnda function url).
- Users need to see rl items (rl_items) and rl lists (rl_lists) in discover page, so add sections in /discover page, right now there are two tabs which are Vocabs and Lists in final there must be 4 tab options, "Vocabs", "Vocab Lists", "RL items," and "RL lists", in rl item discovery users should be able to save in their personal (private) rl items list, and in "RL lists" user shoul be able to subscribe to rl_lists
- in RlItemDetail page I see download button triggers both resign-audio-url and opens a download page, keep this behaviour but I need resign-audio-url trigger for play button of audio in RlItemDetail page, If clicking play can not play audio because url expired, first trigger resign and aftr url reactivated automatically play audio wtihout open download page (I want download button to open download page btw). Note I mean browsers dedicated page for audio by download page do not create any dedicated download page.
- I need pagination in private vocabs page, in private rl_items page, and in all of 4 tabs of discover page, beside pagination all items should be ordered by last modification date or added_date, if no last modified date order by creation date, first items should be last modified item in all lists. You will provided a db schema as always.
- In discover page's vocabs section no vocabs displayed, please fix it, note: my last implementation was on pagination.
- I want you to fix redundant supabase get queries, lets fix them step by step, in /vocabs page on page load I see 4 sequential exact same request to p_vocab_lists and 2 sequential exact same requests to p_vocab_list_items. fix this problem please. There must be a problem with managing states in react component right?

New implementation request(s) for Coder LLM:
- I want you to fix redundant supabase get queries, lets fix them step by step, in /rl-items page (personal materials) on page load I see 4 sequential exact same request for auth/v1/user, 2 sequential exact same requests to p_rl_lists and 2 sequential exact same requests to p_rl_list_items. fix these problem please. There must be a problem with managing states in react component right?